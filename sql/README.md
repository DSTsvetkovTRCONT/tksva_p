# Инспектор (tksva_p) информационного ресурса службы внутреннего аудита (ИРСВА)

### Назначение ИРСВА
ИРСВА предназначен для организации системы непрерывного аудита.
На данном этапе развития ИРСВА предназначен для автоматизации контроля актирования выручки.
Ресурс по запросу пользователя предоставляет информацию о заказах в которых с большой вероятностью не учтена выручка по той или иной услуге.

### Доступ к ИРСВА
Пользователи ИРСВА - сотрудники ПАО Трансконтейнер отвечающие за учет выручки по той или иной услуге.
Пользовательский доступ к ресурсу осуществляется через веб-браузер через указание в адресной строке IP сервера, на котором развернута система.
Доступ возможен только с рабочих станций зарегистрированных в домене Трансконтейнера.  
Планируется регистрация субдомена sva.trcont.com для организации более удобного доступа.

### Состав ИРСВА
ИРСВА состоит из трех работающих параллельно систем:
- Инспектор (tksva_p). Система автоматически обновляет источники данных для поддержания их актаульности.
- Очередь Заданий (tksva_q). Система принимает от пользователей задания на выгрузку данных необходимых им для анализа, запускает скрипты формирующие выгрузки и по мере формирования выгрузок предоставляет доступ к ним.
- Веб-интерфейс (tksva). Система позволяет отправлять в Очередь Заданий задачи пользователей на подготовку и выгрузку данных и по по мере формирования выгрузок, скачивать их на локальную машину пользователя.

Системы работают на сервере под управлением ОС Linux, обмен информацией между системами осуществляется с помощью БД Postgresql.
Код и инструкции по развёртыванию каждой системы хранятся в отдельном репозитории.

Данный репозиторий относится к Инспектору (tksva_p).
Репозитарии очереди заданий (tksva_q) и веб-интерфейса (tksva) доступны по ссылкам:
- [Очередь заданий (tksva_q)](/ "Скоро сделаю")
- [Веб-интерфейс (tksva)](/ "Скоро сделаю")

#### Описание алгоритма
Инспектор запускается каждый час с помощью Cron.
На данном этапе развития проекта поддерживается актаульность данных таблицы DWH ***audit._sales__execution_orders***.
Данная таблица содержит данные из таблицы DWH ***audit.sales__execution_orders*** с добавленной информацией по актированию услуг предоставления вагона и контейнера ближайшие до и после даты отправления.
При каждом запуске инспектор сравнивает данные в таблице ***audit.sales__execution_orders*** и ***audit._sales__execution_orders*** и в случае если в ***audit.sales__execution_orders*** информация отличается, запускается SQL-скрипт, добавляющий информацию по актированию услуг предоставления вагона и контейнера ближайшие до и после даты отправления.
Скрипт запускается поэтапно (для каждой дороги отдельно) чтобы не превышать требования DWH по объему используемой оперативной памяти.
Данные добавляются во временную таблицу ***audit._sales__execution_orders_tmp***.
Как только все данные в таблице ***audit._sales__execution_orders_tmp*** подготовлены, ИРСВА блокируется для подготовки новых выгрузок.
Если ИРСВА подготавливает выгрузку для пользователя, инспектор ожидает когда эта выгрузка будет подготовлена, меняет местами таблицы ***audit._sales__execution_orders_tmp*** и ***audit._sales__execution_orders***, затем снимает блокировку подготовки новых выгрузок, удаляет таблицу ***audit._sales__execution_orders_tmp***.

#### Инструкция по развертыванию
В домашней директории создаём директорию ***tksva_p*** в которую копируем все файлы репозитория.
В директории ***~/tksva_p*** создаём файл ***.env*** по образцу файла ***.envexample***.

Обновляем пакеты:
```bash
sudo apt update
sudo apt -y upgrade
```
Устанавливаем пакет venv (если не был установлен ранее):
```bash
sudo apt install python3-venv
```
В директории tksva_p создаём и активируем виртуальное окружение:
```bash
cd ~/tksva_p
python3 -m venv .venv
source .venv/bin/activate
```
Из файла requirements.txt устанавливаем зависимости:
```bash
pip install -r requirements.txt
```
Отключаем виртуальную среду:
```bash
deactivate
```
Создаём задание cron:
```bash
crontab -e
```
```
15 * * * * cd ~/tksva_p; source .venv/bin/activate; ~/tksva_p/.venv/bin/python3 ~/tksva_p/main.py
```